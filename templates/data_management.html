{% extends "base.html" %}

{% block title %}Manage Data - Course Scheduler{% endblock %}

{% block content %}
<div class="p-4 @container">
    <div class="flex flex-col items-stretch justify-start rounded-lg bg-white p-6 shadow-md">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Manage University Data</h2>

        <div class="flex border-b border-gray-200 mb-6">
            <button class="py-2 px-4 text-sm font-medium {% if active_tab == 'lecturers' %}text-[#0d78f2] border-b-2 border-[#0d78f2]{% else %}text-gray-500 hover:text-gray-700{% endif %}" onclick="window.location.href='{{ url_for('data_management', type='lecturers') }}'">Lecturers</button>
            <button class="py-2 px-4 text-sm font-medium {% if active_tab == 'rooms' %}text-[#0d78f2] border-b-2 border-[#0d78f2]{% else %}text-gray-500 hover:text-gray-700{% endif %}" onclick="window.location.href='{{ url_for('data_management', type='rooms') }}'">Rooms</button>
            <button class="py-2 px-4 text-sm font-medium {% if active_tab == 'departments' %}text-[#0d78f2] border-b-2 border-[#0d78f2]{% else %}text-gray-500 hover:text-gray-700{% endif %}" onclick="window.location.href='{{ url_for('data_management', type='departments') }}'">Departments</button>
            <button class="py-2 px-4 text-sm font-medium {% if active_tab == 'courses' %}text-[#0d78f2] border-b-2 border-[#0d78f2]{% else %}text-gray-500 hover:text-gray-700{% endif %}" onclick="window.location.href='{{ url_for('data_management', type='courses') }}'">Courses</button>
        </div>

        <div>
            {% if active_tab == 'lecturers' %}
            <div id="lecturers-tab">
                <div class="flex flex-wrap justify-between gap-3 mb-4">
                    <p class="text-lg font-bold text-[#111418]">Lecturers</p>
                    <button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-8 px-4 bg-[#0d78f2] text-white text-sm font-medium leading-normal" onclick="showAddModal('lecturer')">
                        <span class="truncate">Add Lecturer</span>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="text-left text-sm font-semibold text-gray-600 border-b">
                                <th class="py-3 px-4">Name</th>
                                <th class="py-3 px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lecturer in lecturers %}
                            <tr class="border-b last:border-b-0 text-sm">
                                <td class="py-3 px-4">{{ lecturer.name }}</td>
                                <td class="py-3 px-4">
                                    <button class="text-red-500 hover:text-red-700" onclick="deleteItem('teachers', '{{ lecturer._id }}')">Delete</button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="2" class="py-3 px-4 text-center text-gray-500">No lecturers added yet.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% elif active_tab == 'rooms' %}
            <div id="rooms-tab">
                <div class="flex flex-wrap justify-between gap-3 mb-4">
                    <p class="text-lg font-bold text-[#111418]">Rooms</p>
                    <button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-8 px-4 bg-[#0d78f2] text-white text-sm font-medium leading-normal" onclick="showAddModal('room')">
                        <span class="truncate">Add Room</span>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="text-left text-sm font-semibold text-gray-600 border-b">
                                <th class="py-3 px-4">Name</th>
                                <th class="py-3 px-4">Capacity</th>
                                <th class="py-3 px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for room in rooms %}
                            <tr class="border-b last:border-b-0 text-sm">
                                <td class="py-3 px-4">{{ room.name }}</td>
                                <td class="py-3 px-4">{{ room.capacity }}</td>
                                <td class="py-3 px-4">
                                    <button class="text-red-500 hover:text-red-700" onclick="deleteItem('rooms', '{{ room._id }}')">Delete</button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="3" class="py-3 px-4 text-center text-gray-500">No rooms added yet.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% elif active_tab == 'departments' %}
            <div id="departments-tab">
                <div class="flex flex-wrap justify-between gap-3 mb-4">
                    <p class="text-lg font-bold text-[#111418]">Departments</p>
                    <button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-8 px-4 bg-[#0d78f2] text-white text-sm font-medium leading-normal" onclick="showAddModal('department')">
                        <span class="truncate">Add Department</span>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="text-left text-sm font-semibold text-gray-600 border-b">
                                <th class="py-3 px-4">Name</th>
                                <th class="py-3 px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for department in departments %}
                            <tr class="border-b last:border-b-0 text-sm">
                                <td class="py-3 px-4">{{ department.name }}</td>
                                <td class="py-3 px-4">
                                    <button class="text-red-500 hover:text-red-700" onclick="deleteItem('departments', '{{ department._id }}')">Delete</button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="2" class="py-3 px-4 text-center text-gray-500">No departments added yet.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% elif active_tab == 'courses' %}
            <div id="courses-tab">
                <div class="flex flex-wrap justify-between gap-3 mb-4">
                    <p class="text-lg font-bold text-[#111418]">Courses</p>
                    <button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-8 px-4 bg-[#0d78f2] text-white text-sm font-medium leading-normal" onclick="showAddModal('course')">
                        <span class="truncate">Add Course</span>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="text-left text-sm font-semibold text-gray-600 border-b">
                                <th class="py-3 px-4">Name</th>
                                <th class="py-3 px-4">Lecturer(s)</th>
                                <th class="py-3 px-4">Lectures per Week</th>
                                <th class="py-3 px-4">Level</th>
                                <th class="py-3 px-4">Department(s)</th>
                                <th class="py-3 px-4">Students</th>
                                <th class="py-3 px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for course in courses %}
                            <tr class="border-b last:border-b-0 text-sm">
                                <td class="py-3 px-4">{{ course.name }}</td>
                                <td class="py-3 px-4">{{ course.lecturer_names }}</td>
                                <td class="py-3 px-4">{{ course.lectures_per_week }}</td>
                                <td class="py-3 px-4">{{ course.level }}</td>
                                <td class="py-3 px-4">{{ course.departments_str }}</td>
                                <td class="py-3 px-4">{{ course.student_count }}</td>
                                <td class="py-3 px-4">
                                    <button class="text-red-500 hover:text-red-700" onclick="deleteItem('courses', '{{ course._id }}')">Delete</button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="7" class="py-3 px-4 text-center text-gray-500">No courses added yet.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div id="add-modal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div class="bg-white px-4 pt-10 pb-8 sm:p-12 sm:pb-10">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3>
                        <div class="mt-2" id="modal-body"></div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-[#0d78f2] text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" onclick="submitAddForm()">Save</button>
                <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
    function deleteItem(collection, itemId) {
        if (confirm("Are you sure you want to delete this item?")) {
            fetch(`/delete/${collection}/${itemId}`, {
                method: 'DELETE'
            }).then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert("Failed to delete item.");
                }
            });
        }
    }
    
    let currentAddType = '';
    
    function showAddModal(type) {
        currentAddType = type;
        const modal = document.getElementById('add-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');

        modal.classList.remove('hidden');

        if (type === 'lecturer') {
            modalTitle.textContent = "Add New Lecturer";
            modalBody.innerHTML = `
                <form id="add-lecturer-form">
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                    </div>
                </form>
            `;
        } else if (type === 'room') {
            modalTitle.textContent = "Add New Room";
            modalBody.innerHTML = `
                <form id="add-room-form">
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700">Capacity</label>
                        <input type="number" name="capacity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                    </div>
                </form>
            `;
        } else if (type === 'department') {
            modalTitle.textContent = "Add New Department";
            modalBody.innerHTML = `
                <form id="add-department-form">
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700">Department Name</label>
                        <input type="text" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                    </div>
                </form>
            `;
        } else if (type === 'course') {
            const lecturerOptions = `
                {% for lecturer in lecturers %}
                <label class="flex items-center space-x-2 py-2 px-3 hover:bg-gray-100 cursor-pointer">
                    <input type="checkbox" name="lecturers" value="{{ lecturer.name }}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="text-gray-900">{{ lecturer.name }}</span>
                </label>
                {% endfor %}
            `;

            const departmentOptions = `
                {% for department in all_departments %}
                <label class="flex items-center space-x-2 py-2 px-3 hover:bg-gray-100 cursor-pointer">
                    <input type="checkbox" name="departments" value="{{ department }}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="text-gray-900">{{ department }}</span>
                </label>
                {% endfor %}
            `;

            modalTitle.textContent = "Add New Course";
            modalBody.innerHTML = `
                <form id="add-course-form">
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700">Course Name</label>
                        <input type="text" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                    </div>
                    <div class="mt-4 relative">
                        <label class="block text-sm font-medium text-gray-700">Lecturer(s)</label>
                        <button type="button" id="lecturer-dropdown-btn" class="mt-1 block w-full cursor-pointer rounded-md border border-gray-300 bg-white py-2 px-3 text-left shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" aria-haspopup="true" aria-expanded="false">
                            <span id="selected-lecturers">Select lecturers...</span>
                            <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </span>
                        </button>
                        <div id="lecturer-dropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg hidden">
                            <div class="max-h-60 overflow-y-auto">
                                ${lecturerOptions}
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700">Lectures per Week</label>
                        <input type="number" name="lectures_per_week" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700">Level</label>
                        <input type="text" name="level" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                    </div>
                    <div class="mt-4 relative">
                        <label class="block text-sm font-medium text-gray-700">Department(s)</label>
                        <button type="button" id="department-dropdown-btn" class="mt-1 block w-full cursor-pointer rounded-md border border-gray-300 bg-white py-2 px-3 text-left shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" aria-haspopup="true" aria-expanded="false">
                            <span id="selected-departments">Select departments...</span>
                            <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </span>
                        </button>
                        <div id="department-dropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg hidden">
                            <div class="max-h-60 overflow-y-auto">
                                ${departmentOptions}
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700">Student Count</label>
                        <input type="number" name="student_count" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                    </div>
                </form>
            `;
            
            // Add event listeners for the new dropdowns
            setTimeout(() => {
                const setupDropdownWithCheckboxes = (dropdownId, buttonId, selectedSpanId) => {
                    const dropdownBtn = document.getElementById(buttonId);
                    const dropdown = document.getElementById(dropdownId);
                    const selectedSpan = document.getElementById(selectedSpanId);

                    if (!dropdownBtn || !dropdown || !selectedSpan) return;

                    dropdownBtn.addEventListener('click', () => {
                        const isExpanded = dropdownBtn.getAttribute('aria-expanded') === 'true' || false;
                        dropdownBtn.setAttribute('aria-expanded', !isExpanded);
                        dropdown.classList.toggle('hidden');
                    });
                    
                    dropdown.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        checkbox.addEventListener('change', () => {
                            const selected = Array.from(dropdown.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                            selectedSpan.textContent = selected.length > 0 ? selected.join(', ') : 'Select ' + selectedSpanId.replace('selected-', '').replace(/s$/, '') + 's...';
                        });
                    });

                    document.addEventListener('click', (event) => {
                        if (!dropdownBtn.contains(event.target) && !dropdown.contains(event.target)) {
                            dropdown.classList.add('hidden');
                            dropdownBtn.setAttribute('aria-expanded', 'false');
                        }
                    });
                };

                setupDropdownWithCheckboxes('lecturer-dropdown', 'lecturer-dropdown-btn', 'selected-lecturers');
                setupDropdownWithCheckboxes('department-dropdown', 'department-dropdown-btn', 'selected-departments');

            }, 0);
        }
    }
    
    function closeModal() {
        document.getElementById('add-modal').classList.add('hidden');
    }
    
    function submitAddForm() {
        let formId = '';
        let url = '';
        let data = {};

        if (currentAddType === 'lecturer') {
            formId = 'add-lecturer-form';
            url = '/add_teacher';
        } else if (currentAddType === 'room') {
            formId = 'add-room-form';
            url = '/add_room';
        } else if (currentAddType === 'department') {
            formId = 'add-department-form';
            url = '/add_department';
        } else if (currentAddType === 'course') {
            formId = 'add-course-form';
            url = '/add_course';
        }

        const form = document.getElementById(formId);
        const formData = new FormData(form);

        fetch(url, {
            method: 'POST',
            body: formData
        }).then(response => response.json())
          .then(data => {
            if (data.success) {
                alert(data.message);
                closeModal();
                window.location.reload();
            } else {
                alert(data.message);
            }
        });
    }
</script>
{% endblock %}