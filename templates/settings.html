{% extends "base.html" %}

{% block title %}Admin Settings - Course Scheduler{% endblock %}

{% block content %}
<div class="px-40 flex flex-1 justify-center py-5">
    <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
        <div class="flex flex-wrap justify-between gap-3 p-4">
            <p class="text-[#111418] tracking-light text-[32px] font-bold leading-tight min-w-72">Admin Settings</p>
        </div>
        
        <h2 class="text-[#0d141c] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Genetic Algorithm Parameters</h2>
        <div class="p-4 grid grid-cols-[20%_1fr] gap-x-6">
            <div class="col-span-2 grid grid-cols-subgrid border-t border-t-[#cedbe8] py-5">
                <p class="text-[#49739c] text-sm font-normal leading-normal">Population Size</p>
                <p class="text-[#0d141c] text-sm font-normal leading-normal">{{ settings.ga_population_size }}</p>
            </div>
            <div class="col-span-2 grid grid-cols-subgrid border-t border-t-[#cedbe8] py-5">
                <p class="text-[#49739c] text-sm font-normal leading-normal">Number of Generations</p>
                <p class="text-[#0d141c] text-sm font-normal leading-normal">{{ settings.ga_generations }}</p>
            </div>
            <div class="col-span-2 grid grid-cols-subgrid border-t border-t-[#cedbe8] py-5">
                <p class="text-[#49739c] text-sm font-normal leading-normal">Crossover Rate</p>
                <p class="text-[#0d141c] text-sm font-normal leading-normal">{{ settings.ga_crossover_rate }}</p>
            </div>
            <div class="col-span-2 grid grid-cols-subgrid border-t border-t-[#cedbe8] py-5">
                <p class="text-[#49739c] text-sm font-normal leading-normal">Mutation Rate</p>
                <p class="text-[#0d141c] text-sm font-normal leading-normal">{{ settings.ga_mutation_rate }}</p>
            </div>
        </div>
        <div class="flex px-4 py-3 justify-start">
            <button
                id="edit-ga-btn"
                class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#e7edf4] text-[#0d141c] text-sm font-bold leading-normal tracking-[0.015em]"
            >
                <span class="truncate">Edit</span>
            </button>
        </div>

        <h2 class="text-[#0d141c] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Scheduling Constraints</h2>
        <div class="p-4 grid grid-cols-[20%_1fr] gap-x-6">
            <div class="col-span-2 grid grid-cols-subgrid border-t border-t-[#cedbe8] py-5">
                <p class="text-[#49739c] text-sm font-normal leading-normal">Maximum Lecturer Hours per Week</p>
                <p class="text-[#0d141c] text-sm font-normal leading-normal">{{ settings.max_lecturer_hours_per_week }} hours</p>
            </div>
            </div>
        <div class="flex px-4 py-3 justify-start">
            <button
                id="edit-constraints-btn"
                class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#e7edf4] text-[#0d141c] text-sm font-bold leading-normal tracking-[0.015em]"
            >
                <span class="truncate">Edit</span>
            </button>
        </div>
    </div>
</div>

<div id="settingsModal" class="fixed inset-0 z-50 overflow-y-auto hidden">
    <div class="flex items-center justify-center min-h-screen p-4 text-center">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeModal()"></div>
        <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:my-8 sm:w-full sm:max-w-lg p-6">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Edit Settings</h3>
            <form id="settings-form">
                </form>
            <div class="mt-4 flex justify-end gap-2">
                <button
                    type="button"
                    onclick="closeModal()"
                    class="px-4 py-2 rounded-lg bg-gray-200 text-gray-800 font-medium"
                >
                    Cancel
                </button>
                <button
                    type="button"
                    onclick="saveSettings()"
                    class="px-4 py-2 rounded-lg bg-[#0d78f2] text-white font-medium"
                >
                    Save
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentEditType = '';

    document.getElementById('edit-ga-btn').addEventListener('click', () => {
        openModal('genetic_algorithm');
    });

    document.getElementById('edit-constraints-btn').addEventListener('click', () => {
        openModal('scheduling_constraints');
    });

    function openModal(type) {
        currentEditType = type;
        const modal = document.getElementById('settingsModal');
        const form = document.getElementById('settings-form');
        let formContent = '';
        let title = '';
        
        if (type === 'genetic_algorithm') {
            title = 'Edit Genetic Algorithm Parameters';
            formContent = `
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-1">Population Size</label>
                    <input type="number" name="ga_population_size" value="{{ settings.ga_population_size }}" class="border p-2 rounded w-full" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-1">Number of Generations</label>
                    <input type="number" name="ga_generations" value="{{ settings.ga_generations }}" class="border p-2 rounded w-full" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-1">Crossover Rate</label>
                    <input type="number" step="0.01" name="ga_crossover_rate" value="{{ settings.ga_crossover_rate }}" class="border p-2 rounded w-full" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-1">Mutation Rate</label>
                    <input type="number" step="0.01" name="ga_mutation_rate" value="{{ settings.ga_mutation_rate }}" class="border p-2 rounded w-full" required>
                </div>
            `;
        } else if (type === 'scheduling_constraints') {
            title = 'Edit Scheduling Constraints';
            formContent = `
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-1">Maximum Lecturer Hours per Week</label>
                    <input type="number" name="max_lecturer_hours_per_week" value="{{ settings.max_lecturer_hours_per_week }}" class="border p-2 rounded w-full" required>
                </div>
            `;
        }

        document.getElementById('modal-title').textContent = title;
        form.innerHTML = formContent;
        modal.classList.remove('hidden');
    }

    function closeModal() {
        const modal = document.getElementById('settingsModal');
        modal.classList.add('hidden');
    }
    
    function saveSettings() {
        const form = document.getElementById('settings-form');
        const formData = new FormData(form);
        const data = {};

        // Parse form data based on the current edit type
        if (currentEditType === 'genetic_algorithm') {
            data.ga_population_size = parseInt(formData.get('ga_population_size'));
            data.ga_generations = parseInt(formData.get('ga_generations'));
            data.ga_crossover_rate = parseFloat(formData.get('ga_crossover_rate'));
            data.ga_mutation_rate = parseFloat(formData.get('ga_mutation_rate'));
        } else if (currentEditType === 'scheduling_constraints') {
            data.max_lecturer_hours_per_week = parseInt(formData.get('max_lecturer_hours_per_week'));
        }

        fetch('/update_settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(response => response.json())
          .then(result => {
            if (result.success) {
                alert(result.message);
                closeModal();
                window.location.reload(); // Reload to show updated values
            } else {
                alert('Failed to save settings: ' + result.message);
            }
          }).catch(error => {
            console.error('Error saving settings:', error);
            alert('An error occurred while saving settings.');
          });
    }
</script>
{% endblock %}